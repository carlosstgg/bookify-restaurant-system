<div class="actions-bar">
  <h3>Menu Items</h3>
  <button class="btn-primary" (click)="openCreate()">
    <lucide-icon [img]="PlusIcon" size="18"></lucide-icon>
    <span>Add Item</span>
  </button>
</div>

<!-- List Grid View for nicer aesthetics than just a table -->
<div class="grid-container" *ngIf="!isLoading()">
  <div class="menu-card" *ngFor="let item of items()">
    <div class="card-header">
      <span class="category-badge">{{ getCategoryName(item.category_id) }}</span>
      <span class="price-tag">${{ item.price }}</span>
    </div>
    <div class="card-body">
      <h4>{{ item.name }}</h4>
      <p class="desc">{{ item.description || 'No description' }}</p>
    </div>
    <div class="card-footer">
      <span class="status" [class.available]="item.available" [class.unavailable]="!item.available">
        {{ item.available ? 'Available' : 'Unavailable' }}
      </span>
      <div class="actions">
        <button class="icon-btn" (click)="openEdit(item)">
          <lucide-icon [img]="EditIcon" size="16"></lucide-icon>
        </button>
        <button class="icon-btn delete" (click)="deleteItem(item.item_id)">
          <lucide-icon [img]="TrashIcon" size="16"></lucide-icon>
        </button>
      </div>
    </div>
  </div>
  
  <div *ngIf="items().length === 0" class="empty-state">
    <p>No menu items found. Start by creating some categories and items.</p>
  </div>
</div>

<app-modal 
  *ngIf="isModalOpen()" 
  [title]="editingItem() ? 'Edit Item' : 'New Menu Item'" 
  (closed)="closeModal()"
>
  <form [formGroup]="form" (ngSubmit)="save()" class="item-form">
    <div class="form-group">
      <label>Item Name</label>
      <input type="text" formControlName="name" placeholder="e.g. Cheese Burger">
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label>Price</label>
        <input type="number" formControlName="price" min="0" step="0.5">
      </div>
      <div class="form-group">
        <label>Category</label>
        <select formControlName="category_id">
          <option [ngValue]="null">Select Category</option>
          <option *ngFor="let cat of categories()" [value]="cat.category_id">
            {{ cat.name }}
          </option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>Description</label>
      <textarea formControlName="description" rows="3" placeholder="Description visible to customers..."></textarea>
    </div>

    <!-- Recipe / Ingredients Section -->
    <div class="form-group recipe-section">
      <div class="recipe-header">
        <label>Ingredients (Recipe)</label>
        <button type="button" class="btn-xs" (click)="addRecipe()">
          + Add Ingredient
        </button>
      </div>
      
      <div formArrayName="recipes" class="recipe-list">
        <div class="recipe-row" *ngFor="let r of recipes.controls; let i=index" [formGroupName]="i">
          <select formControlName="inventory_id">
            <option [ngValue]="null" disabled>Select Ingredient</option>
            <option *ngFor="let inv of inventoryItems()" [value]="inv.inventory_id">
              {{ inv.item_name }} ({{ inv.unit }})
            </option>
          </select>
          
          <div class="qty-input">
            <input type="number" formControlName="quantity_needed" min="0.01" step="0.1" placeholder="Qty">
            <span class="unit-label" *ngIf="r.get('inventory_id')?.value">
                {{ getUnit(r.get('inventory_id')?.value) }}
            </span>
          </div>

          <button type="button" class="btn-icon delete" (click)="removeRecipe(i)" title="Remove Ingredient">
            <lucide-icon [img]="TrashIcon" size="16"></lucide-icon>
          </button>
        </div>
        <div class="empty-recipe" *ngIf="recipes.controls.length === 0">
          <small>No ingredients linked. This item won't deduct inventory.</small>
        </div>
      </div>
    </div>

    <div class="form-group checkbox-group">
      <input type="checkbox" id="avail" formControlName="available">
      <label for="avail">Available for ordering</label>
    </div>

    <div class="form-actions">
      <button type="button" class="btn-cancel" (click)="closeModal()">Cancel</button>
      <button type="submit" class="btn-submit" [disabled]="form.invalid">Save Item</button>
    </div>
  </form>
</app-modal>
